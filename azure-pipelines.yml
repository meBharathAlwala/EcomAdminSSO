trigger:
- main

variables:
  buildConfiguration: 'production'
  outputFolder: 'dist/EcomAdmin/browser'

stages:
# -------- BUILD STAGE --------
- stage: Build
  displayName: "Build Angular Application"
  jobs:
  - job: BuildAngular
    pool:
      name: 'Default'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: "Install Node.js"

    # Install dependencies and build Angular
    - script: |
        echo "üìç Current directory: %CD%"
        cd "$(Build.SourcesDirectory)"
        npm ci
        npx ng build --configuration %buildConfiguration% --output-path %outputFolder%
      displayName: "Build Angular Project"
      workingDirectory: '$(Build.SourcesDirectory)'

    # Debug: List directories to verify build output
    - script: |
        echo "üìÇ Listing working directory:"
        dir
        echo "üìÇ Listing dist recursively:"
        dir dist /s
      displayName: "Debug: List dist after build"
      workingDirectory: '$(Build.SourcesDirectory)'

    # ‚úÖ Verify dist exists
    - script: |
        if not exist "$(Build.SourcesDirectory)\$(outputFolder)" (
          echo "‚ùå Build failed: $(outputFolder) folder not found."
          exit /b 1
        )
        echo "‚úÖ Build succeeded: $(outputFolder) folder exists."
      displayName: "Verify Build Output"

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)\$(outputFolder)'
        ArtifactName: 'angular-dist'
        publishLocation: 'Container'
      displayName: "Publish Angular Build Artifacts"

# -------- DEPLOY STAGE --------
- stage: Deploy
  displayName: "Deploy to IIS on Azure VM"
  dependsOn: Build
  jobs:
  - deployment: DeployIIS
    environment: 'Production'
    pool:
      name: 'Default'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: angular-dist

          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                $source = "$(Pipeline.Workspace)\angular-dist"
                $destination = "C:\MyApps\EcomAdminUI"

                Write-Host "Stopping IIS site..."
                Import-Module WebAdministration
                Stop-WebSite -Name "EcomAdminUI"

                Write-Host "Clearing old files..."
                if (Test-Path $destination) {
                    Remove-Item "$destination\*" -Recurse -Force
                }

                Write-Host "Copying new files..."
                Copy-Item "$source\*" $destination -Recurse

                Write-Host "Starting IIS site..."
                Start-WebSite -Name "EcomAdminUI"

                Write-Host "‚úÖ Deployment completed successfully."
